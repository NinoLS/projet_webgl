<html>
  <head>
    <title>Transept de la cathédrale d'Amiens</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
  </head>

  <body>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="../Libs/three.min.js"></script>
    <script src="../Libs/OBJLoader.js"></script>

    <script>
      const FLECHE_GAUCHE = 37;
      const FLECHE_DROITE = 39;
      const FLECHE_HAUT = 38;
      const FLECHE_BAS = 40;
      const Z = 90;
      const Q = 81;
      const S = 83;
      const D = 68;
      const X = 88;
      const Y = 89;

      const MIN_X = -5;
      const DEFAULT_X = 0;
      const MAX_X = 5;

      const MIN_Y = -10.4;
      const DEFAULT_Y = 0;
      const MAX_Y = 10.4;

      const MIN_Z = 0;
      const DEFAULT_Z = -20;
      const MAX_Z = 0;

      var container;
      var camera, scene, renderer;
      var dax = 0.002;

      var light;

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
      function Init() {
        container = document.createElement("div");
        document.body.appendChild(container);

        camera = new THREE.PerspectiveCamera(
          90,
          window.innerWidth / window.innerHeight,
          1,
          2000
        );
        camera.rotation.x = 1.6; //rotation vertical devant-derriere
        camera.rotation.y = 9.43; //rotation horizontale

        camera.position.x = DEFAULT_X; //rotation vertical gauche-droite
        camera.position.y = DEFAULT_Y; //rotation vertical gauche-droite
        camera.position.z = DEFAULT_Z; //rotation vertical gauche-droite

        // scene
        scene = new THREE.Scene();

        var ambient = new THREE.AmbientLight(0x221100);
        scene.add(ambient);

        // texture

        var manager = new THREE.LoadingManager();
        manager.onProgress = function (item, loaded, total) {
          console.log(item, loaded, total);
        };

        var texture = new THREE.Texture();

        var loader = new THREE.ImageLoader(manager);
        loader.load("../TranseptSud/TranseptTexture4096.jpg", function (image) {
          texture.image = image;
          texture.needsUpdate = true;
        });

        // Chargement du modèle
        var loader = new THREE.OBJLoader(manager);
        loader.load("../TranseptSud/transeptSudBox.obj", function (object) {
          object.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
              child.material.map = texture;
            }
          });
          scene.add(object);
        });
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        window.addEventListener("resize", onWindowResize, false);

        // FORME LUMIERE
        var GCube = new THREE.SphereGeometry(1, 20, 20);
        var MCube = new THREE.MeshLambertMaterial({ color: 0xff0000 });
        cube = new THREE.Mesh(GCube, MCube);
        cube.position.set(DEFAULT_X, DEFAULT_Y, DEFAULT_Z);
        scene.add(cube);

        // LUMIERE MAIN PERSONNAGE
        light = new THREE.DirectionalLight(0xff0000, 2, 2);
        camera.add(light);
        scene.add(camera);
      }
      function Afficher() {
        renderer.render(scene, camera);
      }
      function Animer() {
        requestAnimationFrame(Animer);
        Afficher();
      }

      function VerifierProcheMur(object, event) {
        if (object.position.x - 0.1 < MIN_X) object.position.x += 0.1;
        if (object.position.x + 0.1 > MAX_X) object.position.x -= 0.1;
        if (object.position.y - 0.1 < MIN_Y) object.position.y += 0.1;
        if (object.position.y + 0.1 > MAX_Y) object.position.y -= 0.1;
        object.position.z = DEFAULT_Z;
      }

      $("*").keydown(function (event) {
        if (event.which == X) light.position.z += 1;
        if (event.which == Y) light.position.z -= 1;

        VerifierProcheMur(cube, event);
        if (event.which == Q) light.rotation.z += 0.05;
        if (event.which == D) light.rotation.z -= 0.05;
        if (event.which == Z) light.translateY(-30);
        if (event.which == S) light.translateY(0.1);

        //caméra
        if (event.altKey) {
          if (event.which == FLECHE_GAUCHE) camera.rotation.y += 0.1;
          if (event.which == FLECHE_DROITE) camera.rotation.y -= 0.1;
          if (event.which == FLECHE_HAUT) camera.rotation.x += 0.1;
          if (event.which == FLECHE_BAS) camera.rotation.x -= 0.1;
        }
        if (event.which == FLECHE_GAUCHE) camera.translateX(-0.1);
        if (event.which == FLECHE_DROITE) camera.translateX(0.1);
        VerifierProcheMur(camera, event, FLECHE_HAUT, FLECHE_BAS);
        if (event.which == FLECHE_HAUT) camera.translateZ(-0.1);
        if (event.which == FLECHE_BAS) camera.translateZ(0.1);
      });

      Init();
      Animer();
    </script>
  </body>
</html>
